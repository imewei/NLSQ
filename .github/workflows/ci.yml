name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION_DEFAULT: "3.12"
  COVERAGE_THRESHOLD: 80

jobs:
  # Stage 0: Change Detection (Run in parallel with validation)
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.filter.outputs.code }}
      docs_only: ${{ steps.filter.outputs.docs_only }}
    steps:
      - uses: actions/checkout@v4

      - name: Check changed files
        id: filter
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if any code files changed
          if echo "$CHANGED_FILES" | grep -E '\.(py|toml|txt|lock)$|^\.github/workflows/ci\.yml$' > /dev/null; then
            echo "code=true" >> $GITHUB_OUTPUT
            echo "docs_only=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Code changes detected - running full test suite"
          else
            echo "code=false" >> $GITHUB_OUTPUT
            echo "docs_only=true" >> $GITHUB_OUTPUT
            echo "ðŸ“š Documentation-only changes - skipping tests"
          fi

  # Stage 1: Validate Dependencies (Fast checks first)
  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt

      - name: Verify dependency specifications
        run: |
          echo "âœ“ Checking that pyproject.toml uses >= constraints..."

          # Check pyproject.toml dependencies for pinned versions
          if grep -E '"[a-zA-Z0-9_-]+\s*==\s*[0-9]' pyproject.toml; then
            echo "âŒ Found pinned versions in pyproject.toml! Use >= for minimum constraints."
            exit 1
          fi

          echo "âœ… All dependencies use minimum version constraints"

      - name: Verify lock file exists
        run: |
          if [ -f requirements-lock.txt ]; then
            echo "âœ… Lock file exists for reproducible builds"
          else
            echo "âš ï¸  Warning: requirements-lock.txt not found"
            echo "For reproducible builds, generate with: pip freeze > requirements-lock.txt"
          fi

      - name: Verify JAX platform-specific installation docs
        run: |
          echo "âœ“ Checking that documentation mentions jax[cuda12-local] for Linux GPU..."

          # Check README.md mentions cuda12-local
          if ! grep -q 'jax\[cuda12-local\]' README.md; then
            echo "âŒ README.md must document jax[cuda12-local] for Linux GPU installation!"
            exit 1
          fi

          # Check requirements-lock.txt has platform notes
          if ! grep -q 'cuda12-local' requirements-lock.txt; then
            echo "âŒ requirements-lock.txt must include jax[cuda12-local] installation notes!"
            exit 1
          fi

          # Verify pyproject.toml uses base jax (not cuda12-local as mandatory)
          if grep -q 'jax\[cuda12-local\]' pyproject.toml; then
            echo "âŒ pyproject.toml must NOT use jax[cuda12-local] (it's Linux-only)!"
            echo "Use base 'jax>=X.Y.Z' and document platform extras separately."
            exit 1
          fi

          echo "âœ… JAX platform-specific installation is properly documented"

  # Stage 2: Code Quality (Can run in parallel with dependency validation)
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code_changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Check code complexity
        run: |
          pip install radon
          radon cc nlsq/ -a -nb --total-average

  # Stage 3: Test Matrix (Run only if code changed)
  test:
    name: Test - ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    needs: [detect-changes, validate-dependencies]
    if: needs.detect-changes.outputs.code_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12", "3.13"]  # Matches requires-python >= 3.12

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: requirements-dev.txt

      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pytest
            .pytest_cache
          key: pytest-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('tests/**') }}
          restore-keys: |
            pytest-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        shell: bash
        run: |
          pytest tests/ -v -n auto --cov=nlsq --cov-report=xml --cov-report=term \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == env.PYTHON_VERSION_DEFAULT
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: python-${{ matrix.python-version }}
          fail_ci_if_error: false

  # Stage 4: Build & Package (Runs after quality checks pass)
  build:
    name: Build & Validate Package
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    # Always run build, even if tests are skipped (for docs-only changes)
    if: always() && (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') && (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for setuptools-scm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine check-wheel-contents

      - name: Build distributions
        run: python -m build

      - name: Check package metadata
        run: twine check dist/*

      - name: Verify wheel contents
        run: check-wheel-contents dist/*.whl

      - name: Test package installation
        run: |
          pip install dist/*.whl
          python -c "import nlsq; print(f'NLSQ v{nlsq.__version__}')"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distributions-${{ github.sha }}
          path: dist/
          retention-days: 7

  # Stage 5: Integration Tests (Reuses build artifacts)
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: distributions-${{ github.sha }}
          path: dist/

      - name: Install from wheel
        run: pip install dist/*.whl

      - name: Run integration tests
        run: |
          python -c "
          import nlsq
          import jax.numpy as jnp
          import numpy as np

          # Test basic curve fitting
          def exponential(x, a, b):
              return a * jnp.exp(-b * x)

          x = jnp.linspace(0, 4, 50)
          y = 2.5 * jnp.exp(-1.3 * x) + 0.1 * np.random.randn(50)

          popt, pcov = nlsq.curve_fit(exponential, x, y)
          print(f'âœ… Integration test passed: a={popt[0]:.2f}, b={popt[1]:.2f}')
          "

  # Final: Success Gate
  ci-success:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [validate-dependencies, code-quality, test, build, integration]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## ðŸ” CI Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.validate-dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY

          # Validate required jobs succeeded (or were skipped due to docs-only changes)
          FAILED=0

          if [[ "${{ needs.validate-dependencies.result }}" != "success" ]]; then
            echo "âŒ Dependency validation failed"
            FAILED=1
          fi

          # Code quality and tests can be skipped for docs-only changes
          if [[ "${{ needs.code-quality.result }}" != "success" ]] && [[ "${{ needs.code-quality.result }}" != "skipped" ]]; then
            echo "âŒ Code quality checks failed"
            FAILED=1
          fi

          if [[ "${{ needs.test.result }}" != "success" ]] && [[ "${{ needs.test.result }}" != "skipped" ]]; then
            echo "âŒ Tests failed"
            FAILED=1
          fi

          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "âŒ Build failed"
            FAILED=1
          fi

          if [[ "${{ needs.integration.result }}" != "success" ]] && [[ "${{ needs.integration.result }}" != "skipped" ]]; then
            echo "âŒ Integration tests failed"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ One or more CI jobs failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All CI checks passed successfully!" >> $GITHUB_STEP_SUMMARY
